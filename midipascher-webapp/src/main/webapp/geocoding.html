<!DOCTYPE html>
<html>
<head>
  <title>Geocoding with GMap v3 &amp; Exiftool</title>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
  <script src="http://maps.google.com/maps/api/js?sensor=false"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.5/jquery-ui.min.js"></script>
  <script src="http://github.com/tkyk/jquery-history-plugin/raw/master/jquery.history.js"></script>
  <script>

/*

This page's goal :
- retrieve geo-tags from an postal address
- retrieve elevation (thanks to Maps API V3)
- retrieve geographical information (thanks to Maps API V3)
- works when coming from an regular Google Maps url using javascript bookmarklet
- provide cut & paste info for Exiftools
- all marker positions are stored in anchors url (to be able to bookmark them)
- use Google services: Maps API, Google Code API, Font API
- is a valid html5 and jslint.com code

iPhone adds natively GPS info in its pictures. Looking for GPS info, when viewing 
iPhone photos from the Apple View application, leads to Google Maps url. From there, 
via an Javascript bookmark I can go to this geocoding page. Then, thanks to my 
AppleScript (line 38) and the cut & paste info for Exiftools (line 37), I can batch 
update Geotags in a bunch of photos with one drag and drop!

*/

// http://tech.cibul.org/geocode-with-google-maps-api-v3/#comment-195
// http://code.google.com/apis/maps/documentation/javascript/reference.html#Marker
// http://code.google.com/apis/maps/documentation/javascript/services.html#Geocoding
// http://jqueryui.com/demos/autocomplete/#remote-with-cache
// ExifTool : http://www.sno.phy.queensu.ca/~phil/exiftool/
// My AppleScript for batch geotag : http://lashampoo.com/pages/exiftool.scpt

// This line is for JSlint validation
/*global window, indexOf, RegExp, exec, document, prompt, unescape, google, elevation:true, i:true, $ */

var geocoder;
var elevator;
var map;
var marker;
var info;
var geo;
var content;
var exiftool;
var c;

// Eiffel Tower
var lat = 48.858278;
var lng = 2.2942540;
var zoom=16;

// Retrieve info from Google Maps url via javascript bookmarklet
var a = window.location;
var a = (a.hash) ? unescape(a.hash) : unescape(a.search);
var exif = (a.indexOf('exiftool') != -1) ? true : false;
var anchor = new RegExp( "[\\?&][q|ll|sll]+=[(]?([0-9.]+),[ ]?([0-9.]+)" );
var level = new RegExp( "[\\?&]z=([0-9]+)" );
if (anchor.exec(a)) {
  geo = anchor.exec(a);
  lat = geo[1]*1;
  lng = geo[2]*1;
}
if (level.exec(a)) {
  zoom = level.exec(a);
  zoom = zoom[1]*1;
}


// Update keys in results object 
function address_components(results){
  if(results.length>0){
    for(i=0; i<results.length; i++){
      results[results[i].types[0]]=results[i];
    }
  }
  return results;
}


// Update info window 
function update_info(){
  console.log(geo);
  content = '<div class="info">'
    + geo.street_number.short_name + ' ' 
    + geo.route.long_name + ',<br>'
    + geo.postal_code.long_name + ' '
    + geo.locality.long_name 
    + ',<br>' + geo.administrative_area_level_1.long_name 
    + ' (' + geo.country.short_name + ')'
    + '<br>Elevation: ' + geo.elevation + ' m.' 
    + '<br>lat,lng: ' + geo.lat + ',' + geo.lng +'</div>';
  exiftool = '-GPSLatitude=' + geo.lat + 
    ' -GPSLongitude=' + geo.lng +
    ' -GPSAltitude=' + geo.elevation +
    ' -GPSLatitudeRef=N -GPSLongitudeRef=E' +
    ' -GPSAltitudeRef=Above -GPSSpeed=0 -GPSMeasureMode=2' +
    ' -IPTC:City="' + geo.locality.long_name + '"'+
    ' -IPTC:Country-PrimaryLocationCode="' + geo.country.alpha3 + '"'+
    ' -IPTC:Country-PrimaryLocationName="' + geo.country.long_name + '"'+ 
    ' -IPTC:Province-State="' + geo.administrative_area_level_1.long_name + '" ';
}



// Get address from field
function get_address(){
  geocoder.geocode({'latLng': marker.getPosition()}, function(results, status) {
    if (status == google.maps.GeocoderStatus.OK) {
      if (results[0]) {
        geo = address_components(results[0].address_components);
        geo.lat = marker.getPosition().lat();
        geo.lng = marker.getPosition().lng();
        geo.country.alpha3 = c[geo.country.short_name];
        $('#address').val(results[0].formatted_address);
        window.location.hash = '#?q='+geo.lat+','+geo.lng+(zoom?'&z='+zoom:'&&')+(exif?'&exiftool':'');
        elevator.getElevationForLocations({'locations': [marker.getPosition()]}, function(results, status) {
          elevation = (status == google.maps.ElevationStatus.OK && results[0]) ? results[0].elevation.toFixed(0) : 0;
          geo.elevation=elevation;
          update_info();
        });
      }
    }
  });
}


function initialize(){

  //MAP
  var location = new google.maps.LatLng(lat,lng);
  var options = {
    zoom: zoom,
    center: location,
    mapTypeId: google.maps.MapTypeId.SATELLITE
  }; 
  map = new google.maps.Map(document.getElementById("map_canvas"), options);

  // GEOCODER
  geocoder = new google.maps.Geocoder();
  
  // ELEVATION
  elevator = new google.maps.ElevationService();
  
  // MARKER    
  marker = new google.maps.Marker({
    map: map,
    draggable: true
  });
  
  // INFO    
  info = new google.maps.InfoWindow({content:''});

  // SETUP
  marker.setPosition(location);
  map.setCenter(location);
  get_address();

}


function myHistory(hash) {
  // do stuff that loads page content based on hash variable
  if (level.exec(a)) {
    var newzoom = level.exec(a);
    newzoom = newzoom[1]*1;
  }
  if (anchor.exec(hash)) {
    geo = anchor.exec(hash);
    var location = new google.maps.LatLng(geo[1],geo[2]);
    marker.setPosition(location);
    map.setZoom(zoom);
    map.panTo(location);
    get_address();
  }
}


$(document).ready(function() { 

  // Google Maps
  initialize();

  // Autocomplete
  $(function() {
    $("#address").autocomplete({
      //This bit uses the geocoder to fetch address values
      source: function(request, response) {
        geocoder.geocode( {'address': request.term }, function(results, status) {
          response($.map(results, function(item) {
            return {
              label: item.formatted_address,
              value: item.formatted_address,
              latitude: item.geometry.location.lat(),
              longitude: item.geometry.location.lng()
            };
          }));
        });
      },
      //This bit is executed upon selection of an address
      select: function(event, ui) {
        info.close();
        var location = new google.maps.LatLng(ui.item.latitude, ui.item.longitude);
        marker.setPosition(location);
        map.setCenter(location);
        get_address();
      }
    });
  });

  //Add listener to zoom
  google.maps.event.addListener( map , 'zoom_changed' , function() {
    zoom = map.getZoom();
    //alert(zoom);
    get_address();
  });

  //Close info window when start dragging
  google.maps.event.addListener( marker , 'drag' , function() {
    info.close();
  });

  //Add listener to marker for reverse geocoding
  google.maps.event.addListener( marker , 'dragend' , function() {
    get_address();
  });

  //Add listener to marker
  google.maps.event.addListener( marker , 'click' , function() {
    if(exif) { 
      prompt('Exiftool:',exiftool); 
    } else {
      info.close();
      info.setContent(content);
      info.open(map,marker);
    }
  });

  // History
  $.history.init(myHistory);

  b=window.location;
  $("<a id=\"bookmark\" title=\"Save this javascript bookmarklet!\" "+
    "href=\"javascript:a=(typeof(gApplication)!='undefined')?gApplication:false;"+
    "window.location='"+b.protocol+'//'+b.host+b.pathname+"'+"+
    "(a?'#&q='+a.getMap().getCenter()+a.getPageUrl()+'&exiftool':'');\">+</a>").insertBefore('#address');

});

// Convert from ISO 3166-1 Alpha 2 to Alpha 3 Country code (needed for Exiftool)
var c = {
  'AD':'AND','AE':'ARE','AF':'AFG','AG':'ATG','AI':'AIA','AL':'ALB','AM':'ARM',
  'AN':'ANT','AO':'AGO','AQ':'ATA','AR':'ARG','AS':'ASM','AT':'AUT','AU':'AUS',
  'AW':'ABW','AX':'ALA','AZ':'AZE','BA':'BIH','BB':'BRB','BD':'BGD','BE':'BEL',
  'BF':'BFA','BG':'BGR','BH':'BHR','BI':'BDI','BJ':'BEN','BM':'BMU','BN':'BRN',
  'BO':'BOL','BR':'BRA','BS':'BHS','BT':'BTN','BV':'BVT','BW':'BWA','BY':'BLR',
  'BZ':'BLZ','CA':'CAN','CC':'CCK','CD':'COD','CF':'CAF','CG':'COG','CH':'CHE',
  'CI':'CIV','CK':'COK','CL':'CHL','CM':'CMR','CN':'CHN','CO':'COL','CR':'CRI',
  'CS':'SCG','CU':'CUB','CV':'CPV','CX':'CXR','CY':'CYP','CZ':'CZE','DE':'DEU',
  'DJ':'DJI','DK':'DNK','DM':'DMA','DO':'DOM','DZ':'DZA','EC':'ECU','EE':'EST',
  'EG':'EGY','EH':'ESH','ER':'ERI','ES':'ESP','ET':'ETH','FI':'FIN','FJ':'FJI',
  'FK':'FLK','FM':'FSM','FO':'FRO','FR':'FRA','GA':'GAB','GB':'GBR','GD':'GRD',
  'GE':'GEO','GF':'GUF','GG':'GGY','GH':'GHA','GI':'GIB','GL':'GRL','GM':'GMB',
  'GN':'GIN','GP':'GLP','GQ':'GNQ','GR':'GRC','GS':'SGS','GT':'GTM','GU':'GUM',
  'GW':'GNB','GY':'GUY','HK':'HKG','HM':'HMD','HN':'HND','HR':'HRV','HT':'HTI',
  'HU':'HUN','ID':'IDN','IE':'IRL','IL':'ISR','IM':'IMN','IN':'IND','IO':'IOT',
  'IQ':'IRQ','IR':'IRN','IS':'ISL','IT':'ITA','JE':'JEY','JM':'JAM','JO':'JOR',
  'JP':'JPN','KE':'KEN','KG':'KGZ','KH':'KHM','KI':'KIR','KM':'COM','KN':'KNA',
  'KP':'PRK','KR':'KOR','KW':'KWT','KY':'CYM','KZ':'KAZ','LA':'LAO','LB':'LBN',
  'LC':'LCA','LI':'LIE','LK':'LKA','LR':'LBR','LS':'LSO','LT':'LTU','LU':'LUX',
  'LV':'LVA','LY':'LBY','MA':'MAR','MC':'MCO','MD':'MDA','ME':'MNE','MG':'MDG',
  'MH':'MHL','MK':'MKD','ML':'MLI','MM':'MMR','MN':'MNG','MO':'MAC','MP':'MNP',
  'MQ':'MTQ','MR':'MRT','MS':'MSR','MT':'MLT','MU':'MUS','MV':'MDV','MW':'MWI',
  'MX':'MEX','MY':'MYS','MZ':'MOZ','NA':'NAM','NC':'NCL','NE':'NER','NF':'NFK',
  'NG':'NGA','NI':'NIC','NL':'NLD','NO':'NOR','NP':'NPL','NR':'NRU','NU':'NIU',
  'NZ':'NZL','OM':'OMN','PA':'PAN','PE':'PER','PF':'PYF','PG':'PNG','PH':'PHL',
  'PK':'PAK','PL':'POL','PM':'SPM','PN':'PCN','PR':'PRI','PS':'PSE','PT':'PRT',
  'PW':'PLW','PY':'PRY','QA':'QAT','RE':'REU','RO':'ROU','RS':'SRB','RU':'RUS',
  'RW':'RWA','SA':'SAU','SB':'SLB','SC':'SYC','SD':'SDN','SE':'SWE','SG':'SGP',
  'SH':'SHN','SI':'SVN','SJ':'SJM','SK':'SVK','SL':'SLE','SM':'SMR','SN':'SEN',
  'SO':'SOM','SR':'SUR','ST':'STP','SV':'SLV','SY':'SYR','SZ':'SWZ','TC':'TCA',
  'TD':'TCD','TF':'ATF','TG':'TGO','TH':'THA','TJ':'TJK','TK':'TKL','TL':'TLS',
  'TM':'TKM','TN':'TUN','TO':'TON','TR':'TUR','TT':'TTO','TV':'TUV','TW':'TWN',
  'TZ':'TZA','UA':'UKR','UG':'UGA','UM':'UMI','US':'USA','UY':'URY','UZ':'UZB',
  'VA':'VAT','VC':'VCT','VE':'VEN','VG':'VGB','VI':'VIR','VN':'VNM','VU':'VUT',
  'WF':'WLF','WS':'WSM','YE':'YEM','YT':'MYT','ZA':'ZAF','ZM':'ZMB','ZW':'ZWE'
};

  </script>
  <link href='//fonts.googleapis.com/css?family=Reenie+Beanie&amp;subset=latin' rel='stylesheet' type='text/css' />
  <style>
    html , body , #map_canvas {
      margin:0; 
      padding:0;
      font-family: Arial;
      font-size: 16px;
      width:100%; height:100%;
    }
    .ui-autocomplete {
      background-color: white;
      width: 300px;
      border: 1px solid #cfcfcf;
      list-style-type: none;
      padding-left: 0px;
    }
    .info { width:100%; height:100%; 
      font-size:1.5em; font-family: "Reenie Beanie",Arial; }
    #address { z-index:100;position:absolute; 
      top:25px;left:90px; width:50%; font-size:14pt;
      min-width:225px;
    }
    #bookmark { z-index:101;position:absolute; 
      top:33px;left:70px; font-size:12pt;
      background-color:#999;color:#fff;padding:2px;
      text-decoration:none; line-height:10pt; }
  </style>
</head>

<body>
  <div id="map_canvas"></div>
  <input id="address" type="search" value="" />



<!-- Statistics + analytics : you can delete from here -->

<script>
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script>
try {
  var pageTracker = _gat._getTracker("UA-9459430-1");
  pageTracker._trackPageview();
} catch(err) {}
</script>
<script src="//static.woopra.com/js/woopra.v2.js"></script>
<script>
woopraTracker.track();
</script>

<!-- Statistics + analytics : you can delete until here -->


</body>
</html>
